<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Saviora</title>
  <link rel="icon" type="image/png" href="src/savlogo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --secondary: #64748b;
      --accent: #06b6d4;
      --background: #bdcff1;
      --card-bg: rgba(255, 255, 255, 0.92);
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --border: rgba(0, 0, 0, 0.1);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);

      --chat-bg: rgba(255,255,255,0.82);
      --menu-bg: rgba(255,255,255,0.98);
      --menu-text: #111827;

      --panel-max-width: 640px;
      --surface-height-desktop: 320px;
      --surface-height-mobile: 48vh;
    }

    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden; /* защита от горизонтального скролла */
    }

    /* Скрыть основной контент до проверки авторизации */
    .pre-auth .center-wrap { visibility: hidden; }
    #auth { display: block; }

    h1 { font-size: 24px; margin: 0 0 20px; text-align: center; font-weight: 700; color: var(--text-primary); }
    h3 { font-size: 18px; font-weight: 600; margin: 0; color: var(--text-primary); }

    /* Центрирование контейнера */
    .center-wrap {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center; /* вертикальный центр по умолчанию */
      max-width: var(--panel-max-width);
      width: 100%;
      margin: 0 auto;
      padding: 24px 8px;
      box-sizing: border-box;
    }

    .row { width: 100%; max-width: var(--panel-max-width); margin: 0 auto; }
    .card {
      position: relative;
      width: 100%; max-width: var(--panel-max-width);
      background: var(--card-bg);
      border-radius: 16px; padding: 24px; box-shadow: var(--shadow);
      backdrop-filter: blur(10px); border: 1px solid var(--border); animation: fadeIn 0.3s ease-out;
      overflow: visible;
      scrollbar-gutter: stable both-edges;
    }

    .card .top-back {
      position: absolute; top: 12px; left: 12px;
      width: 32px; height: 32px; border-radius: 10px;
      border: 1px solid var(--border); background: #fff; color: var(--text-primary);
      display: inline-flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: var(--shadow); font-size: 18px; line-height: 1;
    }
    .top-back:hover { background: rgba(0,0,0,0.04); }

    .header-row {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding-left: 36px;
      margin-bottom: 16px;
    }

    /* Единые поверхности */
    .surface {
      background: rgba(255,255,255,0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-sizing: border-box;
      width: 100%;
      height: var(--surface-height-desktop);
      max-height: var(--surface-height-desktop);
      min-height: var(--surface-height-desktop);
      overflow: hidden; /* исключаем горизонтальный скролл */
    }

    @media (max-width: 900px) {
      .center-wrap {
        min-height: 100svh;     /* корректная высота с учётом адресной строки */
        padding: 16px 4vw 24px;
        display: grid;
        place-items: center;    /* идеальная центровка */
      }
      .card { padding: 20px; border-radius: 12px; width: min(100%, 680px); }
      .row  { width: min(100%, 680px); }
      .surface {
        height: var(--surface-height-mobile);
        max-height: var(--surface-height-mobile);
        min-height: var(--surface-height-mobile);
      }
    }

    textarea, input, button { font: inherit; border: none; outline: none; }

    /* Шаг 1 */
    #dream {
      padding: 16px; font-size: 16px; line-height: 1.5; resize: none; white-space: pre-wrap;
      overflow: auto;
      overflow-x: hidden; /* только вертикальная прокрутка */
      scrollbar-gutter: stable;
    }

    /* Шаг 2 */
    .dream-view {
      padding: 16px; font-size: 16px; line-height: 1.6; border: 1px dashed var(--border);
      border-radius: 12px; background: rgba(255,255,255,0.8); white-space: pre-wrap;
      height: 100%; box-sizing: border-box; overflow: auto;
      overflow-x: hidden; /* только вверх-вниз */
      scrollbar-gutter: stable;
    }

    .controls { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; justify-content: flex-end; }
    .controls.left { justify-content: flex-start; }
    .btn {
      padding: 12px 20px; border-radius: 12px; background: white; cursor: pointer; font-weight: 500; font-size: 14px;
      transition: background-color 0.2s ease, box-shadow 0.2s ease; border: 1px solid var(--border);
      color: var(--text-primary); box-shadow: var(--shadow);
    }
    .btn:hover { box-shadow: 0 6px 12px -1px rgba(0,0,0,0.15); }
    .btn.primary { background: var(--primary); color: white; border: none; font-weight: 600; }
    .btn.primary:hover { background: var(--primary-hover); }
    .btn.secondary { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
    .btn.secondary:hover { background: rgba(0,0,0,0.05); }

    .blocks { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
    .chip {
      padding: 8px 16px; border-radius: 20px; background: #e0f2fe; color: #0369a1; cursor: pointer; border: none; font-size: 14px; font-weight: 500;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .chip:hover { background: #bae6fd; transform: translateY(-1px); }
    .chip.active { background: var(--primary); color: white; box-shadow: var(--shadow); }

    /* Шаг 3 — чат */
    .chat-wrap { position: relative; height: var(--surface-height-desktop); overflow: hidden; }
    @media (max-width: 900px) { .chat-wrap { height: var(--surface-height-mobile); } }

    .chat {
      display: flex; flex-direction: column; gap: 12px;
      height: 100%;
      padding: 20px 24px 44px 20px; /* больше воздуха снизу */
      border-radius: 12px;
      background: var(--chat-bg);
      overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;
      scrollbar-gutter: stable;
      contain: paint;
    }

    /* Пузырьки */
    .msg {
      max-width: min(85%, 560px);
      padding: 12px 16px;
      border-radius: 20px;     /* чуть мягче */
      font-size: 15px;
      line-height: 1.5;
      word-wrap: break-word;
      overflow-wrap: anywhere;
      white-space: pre-wrap;
      margin-bottom: 6px;      /* дополнительный зазор между пузырями */
    }
    .bot  { background: #f1f5f9; color: var(--text-primary); align-self: flex-start; border: 1px solid #e2e8f0; }
    .user { background: var(--primary);  color: #fff;               align-self: flex-end;   border: none; }

    .msg.bot.final { background: #e0f2fe; color: #0c4a6e; border: 1px solid #bae6fd; }
    .msg.final-global { background: linear-gradient(135deg, #fef3c7, #fed7aa); border-left: 4px solid #f59e0b; color: #78350f; }

    /* «Думаю…» как системное сообщение внутри чата (внизу) */
    .msg.thinking {
      background: transparent;
      color: var(--text-secondary);
      border: none;
      padding: 4px 8px;
      font-size: 13px;
      align-self: flex-start;
    }

    /* Стабилизатор внизу */
    .chat-stabilizer { height: 6px; flex: 0 0 auto; }

    .muted { color: var(--text-secondary); font-size: 14px; margin: 8px 0; }

    .footer {
      margin-top: 16px;
      display: flex; gap: 12px; flex-wrap: wrap; align-items: center;
      padding-bottom: max(8px, env(safe-area-inset-bottom, 0px)); /* безопасная зона iOS */
    }

    /* Панель ввода чата */
    .chat-input-bar {
      position: relative;
      width: 100%;
      min-height: 56px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      box-sizing: border-box;
    }

    #userInput {
      width: 100%;
      height: 40px;
      min-height: 40px;
      max-height: 40px;
      padding: 8px 108px 8px 14px;
      border-radius: 20px;
      font-size: 15px;
      line-height: 22px;
      resize: none;
      overflow: hidden;
      background: rgba(255,255,255,0.97);
      border: 1px solid var(--border);
      box-sizing: border-box;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      -webkit-appearance: none;
      appearance: none;
      -webkit-text-size-adjust: 100%;
    }

    .send-icon-btn,
    .attach-icon-btn {
      position: absolute;
      bottom: 10px;
      top: auto;
      width: 36px; height: 36px; border-radius: 18px;
      display: inline-flex; align-items: center; justify-content: center;
      cursor: pointer; box-shadow: none; transition: background-color 0.15s ease;
    }
    .attach-icon-btn { right: 68px; background: #fff; color: var(--text-primary); border: 1px solid var(--border); font-size: 18px; }
    .send-icon-btn   { right: 20px; background: var(--primary); color: #fff; border: none; font-size: 16px; }
    .attach-icon-btn:hover { background: rgba(0,0,0,0.04); }
    .send-icon-btn:hover   { background: var(--primary-hover); }

    .attach-menu {
      position: absolute; right: 20px; bottom: 56px;
      background: var(--menu-bg); color: var(--menu-text);
      border-radius: 12px; padding: 8px 0; box-shadow: 0 12px 32px rgba(0,0,0,0.15);
      min-width: 220px; z-index: 10; animation: fadeIn 0.15s ease-out; border: 1px solid var(--border);
      display: none;
    }
    .attach-item { width: 100%; text-align: left; background: transparent; border: none; color: var(--menu-text); padding: 10px 14px; font-size: 14px; cursor: pointer; }
    .attach-item:hover { background: rgba(0,0,0,0.04); }

    .jump-bottom-btn {
      position: absolute; right: 14px; bottom: 16px; width: 36px; height: 36px; border-radius: 18px;
      background: var(--primary); color: #fff; border: none; box-shadow: var(--shadow); cursor: pointer;
      display: none; opacity: 0.96; font-size: 18px; line-height: 1; transition: background-color 0.2s ease;
    }
    .jump-bottom-btn:hover { background: var(--primary-hover); }

    .nav-previews { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; align-items: stretch; }
    .block-preview {
      min-height: 52px; max-height: 52px; border-radius: 12px; border: 1px dashed var(--border); box-shadow: var(--shadow);
      padding: 8px; font-size: 12px; color: var(--text-primary); opacity: 0.95; cursor: pointer;
      display: flex; align-items: center; justify-content: center; text-align: center; transition: opacity 0.2s ease, background-color 0.2s ease;
      user-select: none; overflow: hidden;
    }
    .block-preview .label {
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; max-width: 100%; line-height: 1.25;
    }
    .block-preview.disabled { cursor: default; filter: grayscale(0.2); opacity: 0.8; }

    .dialog-header { display: flex; align-items: center; justify-content: center; gap: 8px; padding-left: 36px; margin-bottom: 12px; }
    .back-link {
      display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 8px;
      border: 1px solid var(--border); background: #fff; color: var(--text-primary); font-weight: 700; cursor: pointer; box-shadow: var(--shadow);
    }
    .back-link:hover { background: rgba(0,0,0,0.04); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .thinking { display: none; } /* внешний thinking не используем */

    /* Стили скроллбара */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 3px; }
    ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary-hover); }

    /* Быстрые ответы */
    .quick { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
    .quick button {
      appearance: none; -webkit-appearance: none; background: #fff; color: var(--text-primary);
      border: 1px solid rgba(0,0,0,0.08); border-radius: 8px; padding: 10px 14px;
      font-size: 14px; line-height: 1.2; cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      transition: background-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease, transform 0.06s ease;
      white-space: nowrap;
    }
    .quick button:hover { border-color: rgba(0,0,0,0.16); box-shadow: 0 4px 10px rgba(0,0,0,0.08); transform: translateY(-1px); }
    .quick button:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.18), 0 4px 10px rgba(0,0,0,0.08); border-color: var(--primary); }

    /* Подсказка над dreamView */
    .hint-inline { margin: 6px 0 10px; color: var(--text-secondary); font-size: 14px; display: flex; align-items: center; gap: 8px; min-height: 32px; }
    .hint-refresh {
      appearance: none; -webkit-appearance: none; background: transparent; border: none; cursor: pointer; min-width: 32px; min-height: 32px;
      padding: 4px 8px; display: inline-flex; align-items: center; justify-content: center; line-height: 1; font-size: 17px; color: var(--primary);
      opacity: 0.95; position: relative; z-index: 1; border-radius: 8px;
      transition: transform 0.12s ease, opacity 0.12s ease, color 0.12s ease, background-color 0.12s ease;
    }
    .hint-refresh:hover { opacity: 1; color: var(--primary-hover); transform: scale(1.06); background: rgba(37, 99, 235, 0.06); }
    .hint-refresh:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25); }
    @media (pointer: coarse) { .hint-refresh { min-width: 36px; min-height: 36px; padding: 6px 10px; } }
  </style>
</head>
<body class="pre-auth">
  <div id="auth" style="display:block;">
    <div class="auth-bg" style="position:absolute;inset:0;background:var(--background);opacity:1;z-index:1;"></div>
    <div class="auth-card" style="position:fixed;inset:0;display:grid;place-items:center;padding:16px;z-index:2;">
      <div style="background:var(--card-bg);box-shadow:0 20px 60px rgba(0,0,0,0.2);border-radius:24px;padding:40px 32px;width:min(560px,92vw);display:flex;flex-direction:column;align-items:center;backdrop-filter:blur(20px);border:1px solid var(--border);">
        <h2 style="font-size:24px;font-weight:700;margin-bottom:24px;color:var(--text-primary);text-align:center;">Доступ ограничен</h2>
        <input type="password" id="authPass" placeholder="Пароль" style="font-size:16px;padding:16px;border-radius:12px;border:1px solid var(--border);margin-bottom:20px;width:100%;max-width:280px;background:rgba(255,255,255,0.8);transition:all 0.2s ease;text-align:center;">
        <button id="authBtn" style="font-size:16px;padding:16px 32px;border-radius:12px;border:none;background:var(--primary);color:#fff;font-weight:600;cursor:pointer;transition:all 0.2s ease;width:100%;max-width:280px;">Войти</button>
        <div id="authError" style="color: var(--error); margin-top: 16px; display: none; font-size: 14px;">Неверный пароль</div>
      </div>
    </div>
  </div>

  <div class="center-wrap">
    <h1>Saviora</h1>

    <!-- Шаг 1 -->
    <div id="step1">
      <div class="row">
        <div class="card">
          <div class="header-row">
            <h3>Мы всегда рады новым историям</h3>
          </div>
          <textarea id="dream" class="surface" placeholder="Запишите свое сновидение..."></textarea>
          <div class="controls">
            <button id="toStep2" class="btn primary">Далее →</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Шаг 2 -->
    <div id="step2" style="display:none;">
      <div class="row">
        <div class="card">
          <button id="backTo1Top" class="top-back" title="Назад">&larr;</button>
          <div class="header-row">
            <h3>Смысловые блоки</h3>
          </div>

          <div class="hint-inline">
            Выделите фрагмент и нажмите «Добавить блок» или «Весь текст»
            <button class="hint-refresh" id="refreshInline" title="Обновить выбранные блоки" aria-label="Обновить выбранные блоки">↻</button>
          </div>

          <div class="dream-view surface" id="dreamView"></div>

          <div class="controls left" style="justify-content: space-between; align-items: center;">
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button id="addBlock" class="btn secondary">Добавить блок</button>
              <button id="addWholeBlock" class="btn secondary">Весь текст</button>
            </div>
            <div style="margin-left:auto;"></div>
          </div>

          <div class="blocks" id="blocks"></div>

          <div class="controls">
            <button id="toStep3" class="btn primary">Начать</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Шаг 3 -->
    <div id="step3" style="display:none;">
      <div class="row">
        <div class="card">
          <button id="backTo2Top" class="top-back" title="Назад">&larr;</button>
          <div class="dialog-header">
            <h3>Диалог по вашему сновидению</h3>
          </div>

          <div id="currentBlock" class="muted" style="margin: 0 0 8px;">Блок не выбран</div>

          <div class="chat-wrap surface" style="padding:0;">
            <div class="chat" id="chat">
              <!-- Сообщения добавляются выше индикатора -->
              <div id="thinking" class="msg thinking" style="display:none;">Думаю<span class="dots">...</span></div>
              <div class="chat-stabilizer"></div>
              <button id="jumpToBottom" class="jump-bottom-btn" title="В конец">▼</button>
            </div>
          </div>

          <div class="footer">
            <div id="chatInputBar" class="chat-input-bar" style="width:100%;">
              <textarea id="userInput" placeholder="Напишите ответ..." rows="1"></textarea>
              <button id="attachBtn" class="attach-icon-btn" title="Действия">📎</button>
              <button id="sendAnswerBtn" class="send-icon-btn" title="Отправить">➤</button>
              <div id="attachMenu" class="attach-menu">
                <button id="menuBlockInterpret" class="attach-item">📖 Толкование</button>
                <button id="menuFinalInterpret" class="attach-item">🎯 Итог</button>
              </div>
            </div>
          </div>

          <div class="nav-previews">
            <div id="prevPreview" class="block-preview disabled"><span class="label">…</span></div>
            <div id="nextPreview" class="block-preview"><span class="label"></span></div>
          </div>

          <!-- Скрытые служебные кнопки -->
          <div style="display:none;">
            <button id="blockInterpretBtn">Толкование</button>
            <button id="finalInterpretBtn">Итог</button>
            <button id="prevBlockBtn">◀</button>
            <button id="nextBlockBtn">▶</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="src/main.js"></script>
</body>
</html>
